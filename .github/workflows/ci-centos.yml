name: CI in Docker on CentOS

on:
  push:
    paths-ignore:
      - "docs/**"
      - README.md
  pull_request:
    paths-ignore:
      - "docs/**"
      - README.md
  schedule:
    # At 03:30 on Wednesday.
    - cron: "30 3 * * 3"

jobs:
  build:
    name: Build on CentOS 7
    runs-on: ubuntu-18.04
    container: centos:7

    steps:
      - uses: actions/checkout@v2
      - name: Get basic dependencies
        run: |
          yum update -y
          yum install -y wget git
          yum groupinstall -y 'Development Tools'
      - name: Install conda
        run: |
          wget https://repo.anaconda.com/archive/Anaconda3-2020.02-Linux-x86_64.sh
          chmod u+x Anaconda3-2020.02-Linux-x86_64.sh
          ./Anaconda3-2020.02-Linux-x86_64.sh -b
      - name: Set variables with conda executable and activate
        run: |
          echo "CONDA=/github/home/anaconda3/bin/conda" >> $GITHUB_ENV
          echo "CONDA_PREFIX=$HOME/conda-env" >> $GITHUB_ENV
          echo "CONDA_BUILD=1" >> $GITHUB_ENV
      - name: Create installation directory
        run: mkdir install
      - name: Set number of cores for compilation
        run: |
          echo "MAKEFLAGS=-j$(nproc)" >> $GITHUB_ENV
      - name: Get GRASS GIS compile time yum dependencies
        run: |
          yum install -y zlib-devel \
              mesa-libGL-devel mesa-libGLU-devel \
              libXmu-devel libX11-devel fftw-devel \
              lesstif-devel wxGTK-devel \
              libxml2 geos geos-devel \
              netcdf netcdf-devel \
              cairo-devel \
              libpng-devel
      - name: Get GRASS GIS runtime conda dependencies
        run: |
          $CONDA env create --file environment.yml --prefix $CONDA_PREFIX
      - name: Set variables with conda executable and activate
        run: |
          echo "CONDA_ACTIVATE=$CONDA_PREFIX/lib/python*/venv/scripts/common/activate" >> $GITHUB_ENV
      - name: Install more recent GCC
        run: |
          source $CONDA_ACTIVATE
          $CONDA install --yes -c conda-forge gcc_linux-64 gxx_linux-64
      - name: Examine the new conda environment
        run: |
          echo "In environment:"
          ls $CONDA_PREFIX
          echo "In environment's bin:"
          ls $CONDA_PREFIX/bin
          echo "In environment's bin - configs:"
          ls $CONDA_PREFIX/bin/*config*
          echo "In environment's include:"
          ls $CONDA_PREFIX/include
          echo "In environment's lib:"
          ls $CONDA_PREFIX/lib
      - name: Set LD_LIBRARY_PATH for GRASS GIS compilation
        run: |
          echo "LD_LIBRARY_PATH=$CONDA_PREFIX/lib" >> $GITHUB_ENV
      - name: Get and compile GRASS GIS
        run: |
          source $CONDA_ACTIVATE
          bash ./compile.sh master $CONDA_PREFIX $HOME/install
      - name: Add the bin directory to PATH
        run: |
          echo "$HOME/install/bin" >> $GITHUB_PATH
      - name: Basic test of GRASS GIS
        run: |
          source $CONDA_ACTIVATE
          bash ./test-quick.sh grass79
      - name: Thorough test of GRASS GIS
        run: |
          source $CONDA_ACTIVATE
          bash ./test-thorough.sh grass79 grass-code
